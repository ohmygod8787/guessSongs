<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猜歌大挑戰</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* 加粗的描邊效果 1.5px */
        .text-outline {
            text-shadow: 
                -1.5px -1.5px 0 #000,  
                 1.5px -1.5px 0 #000,
                -1.5px  1.5px 0 #000,
                 1.5px  1.5px 0 #000,
                -1.5px  0     0 #000,
                 1.5px  0     0 #000,
                 0     -1.5px 0 #000,
                 0      1.5px 0 #000;
        }

        body { background-color: #000; color: #fff; font-family: "Microsoft JhengHei", sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; transition: background-color 0.5s ease; }
        .game-container { text-align: center; width: 100%; max-width: 700px; padding: 20px; position: relative; z-index: 10; }
        
        /* 用戶名稱移至左上角固定位置 */
        #status-msg { 
            position: fixed;
            top: 25px;
            left: 20px;
            color: #00AEEF; 
            font-size: 20px; 
            font-weight: bold; 
            letter-spacing: 2px; 
            z-index: 1000;
        }

        /* 頂部置中計數器樣式 */
        #song-counter {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            color: #00AEEF;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
            z-index: 1000;
        }
        
        .repurposed-space { min-height: 28px; margin-bottom: 20px; }
        
        #song-display { 
            color: #FF3B30; 
            font-size: 32px; 
            font-weight: 900; 
            margin-bottom: 60px; 
            min-height: 120px; 
            line-height: 1.5; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            transition: opacity 0.3s; 
        }

        .controls { display: flex; justify-content: space-around; align-items: center; margin-bottom: 60px; }
        .btn-box { cursor: pointer; transition: transform 0.2s; flex: 1; display: flex; justify-content: center; }
        .btn-box:active { transform: scale(0.9); }
        .icon { color: #FF3B30; font-size: 55px; }

        .footer { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        .footer-row { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 10px; }
        
        .footer-left-group { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .btn-row { display: flex; align-items: center; gap: 15px; }
        .restart-btn { color: #FF3B30; font-size: 40px; cursor: pointer; }
        
        .mode-btn, .new-btn {
            color: #FF3B30; font-size: 26px; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; border: 3px solid transparent; transition: all 0.2s; box-sizing: border-box;
        }
        .mode-btn.active, .new-btn.active { border: 3px solid #FF3B30; border-radius: 8px; }

        .area-selector { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; max-width: 200px; }
        .area-checkbox { display: none; }
        .area-label {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            width: 85px; height: 45px; border: 1px solid #00AEEF; color: #00AEEF; cursor: pointer; border-radius: 5px; transition: all 0.2s; line-height: 1.1;
        }
        .area-label .letter { font-size: 18px; font-weight: bold; }
        .area-label .years { font-size: 10px; margin-top: 2px; }
        .area-checkbox:checked + .area-label { background-color: #00AEEF; color: #1a1a1a; box-shadow: 0 0 10px rgba(0, 174, 239, 0.4); }

        #menu-icon { position: fixed; top: 20px; right: 20px; font-size: 35px; color: #ff3b30; cursor: pointer; z-index: 1000; }

        /* 彈窗樣式 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: #1a1a1a; border: 2px solid #333; padding: 25px; border-radius: 15px;
            width: 85%; max-width: 350px; text-align: center; color: white;
            display: flex; flex-direction: column; align-items: center;
        }
        .modal-btn {
            background: #28a745; color: white; border: none; padding: 12px 20px;
            font-size: 18px; border-radius: 8px; cursor: pointer; margin: 8px 0;
            transition: 0.2s; width: 90%;
        }
        .modal-btn:hover { opacity: 0.8; }
        .modal-btn.cancel { background: #666; }

        .modal-input {
            width: 80%; padding: 10px; margin: 15px 0; border-radius: 5px; border: 1px solid #444;
            background: #000; color: #fff; font-size: 18px; text-align: center;
        }
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; width: 100%; }
        .color-box { aspect-ratio: 1; border-radius: 5px; cursor: pointer; border: 2px solid transparent; }
        .color-box.selected { border-color: white; box-shadow: 0 0 8px #fff; }

        .record-list { margin: 20px 0; display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .record-item { display: flex; align-items: center; justify-content: space-between; background: #2a2a2a; padding: 12px 15px; border-radius: 10px; border: 1px solid #444; }
        .record-info { display: flex; align-items: center; gap: 12px; cursor: pointer; flex-grow: 1; text-align: left; }
        .record-color-preview { width: 25px; height: 25px; border-radius: 50%; border: 1px solid #fff; }
        .record-name { font-size: 18px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px; }
        .record-del-btn { color: #ff3b30; font-size: 20px; cursor: pointer; padding: 5px; }

        #countdown-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 12px; background: rgba(0, 0, 0, 0.5); display: none; z-index: 1000; }
        #countdown-bar { width: 100%; height: 100%; background-color: #28a745; }
        /* 紫色跑條專用樣式 */
        #hourglass-container { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 12px; 
            background: rgba(0, 0, 0, 0.5); 
            display: none; 
            z-index: 1001; /* 確保在最上層 */
        }
        #hourglass-bar { 
            width: 100%; 
            height: 100%; 
            background-color: #9b59b6; /* 紫色 */
        }

        #yt-player-container { position: fixed; bottom: 0; right: 0; width: 1px; height: 1px; overflow: hidden; opacity: 0.05; z-index: 9999; pointer-events: none; }
        
        @media (max-width: 500px) { 
            #song-display { font-size: 26px; } 
            .area-label { width: 65px; height: 40px; }
            .mode-btn, .new-btn { width: 38px; height: 38px; font-size: 22px; }
        }
    </style>
</head>
<body>

    <!-- 頂部區 -->
    <div id="status-msg" class="text-outline"></div>
    <div id="song-counter" class="text-outline">0 / 0</div>
    <i class="fas fa-bars text-outline" id="menu-icon"></i>

    <!-- A 彈窗：選單 -->
    <div id="modal-a" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">MENU</h2>
            <button class="modal-btn" id="go-to-b">建立記錄</button>
            <button class="modal-btn" id="go-to-c" style="background: #007bff;">讀取記錄</button>
            
            <!-- 沙漏設定 (您上一步加的) -->
            <div style="margin: 10px 0; width: 90%; text-align: center; border: 1px dashed #555; padding: 10px; border-radius: 10px;">
                <label style="font-size: 18px; color: #fff; font-weight: bold;">沙漏設定：</label>
                <input type="number" id="hourglass-time-input" class="modal-input" 
                       style="width: 60px; margin: 0 5px; padding: 5px; display: inline-block;" 
                       value="10" min="10">
                <span style="color: #fff;">秒</span>
                <div style="font-size: 11px; color: #f39c12; margin-top: 5px;">設定沙漏倒數秒數 不可低於10秒</div>
            </div>

            <!-- 新增：倒數設定 (對應 id="extra-btn-1") -->
            <div style="margin: 10px 0; width: 90%; text-align: center; border: 1px dashed #555; padding: 10px; border-radius: 10px;">
                <label style="font-size: 18px; color: #fff; font-weight: bold;">倒數設定：</label>
                <input type="number" id="countdown-time-input" class="modal-input" 
                       style="width: 60px; margin: 0 5px; padding: 5px; display: inline-block;" 
                       value="15" min="1">
                <span style="color: #fff;">秒</span>
                <div style="font-size: 11px; color: #28a745; margin-top: 5px;">設定播放完畢後的自動倒數秒數</div>
            </div>

            <button class="modal-btn cancel" onclick="$('#modal-a').fadeOut()">關閉</button>
        </div>
    </div>

    <!-- B 彈窗：建立記錄 -->
    <div id="modal-b" class="modal-overlay">
        <div class="modal-content">
            <h3>建立用戶資料</h3>
            <input type="text" id="user-name-input" class="modal-input" placeholder="請輸入您的名稱" maxlength="10">
            <div style="font-size: 14px; margin-top: 10px;">請選擇背景顏色：</div>
            <div class="color-grid" id="color-picker"></div>
            <button class="modal-btn" id="confirm-b">確定</button>
            <button class="modal-btn cancel" id="cancel-b">取消</button>
        </div>
    </div>

    <!-- C 彈窗：讀取記錄 -->
    <div id="modal-c" class="modal-overlay">
        <div class="modal-content">
            <h3>讀取過往記錄</h3>
            <div class="record-list" id="record-display-list"></div>
            <button class="modal-btn cancel" onclick="$('#modal-c').fadeOut()">返回</button>
        </div>
    </div>

    <div class="game-container">
        <div class="repurposed-space"></div>
        <div id="song-display" class="text-outline">
            <div id="display-info">點擊開始進行挑戰</div>
            <div id="display-title" class="song-title">歌曲名稱</div>
        </div>

        <div class="controls">
            <div class="btn-box" id="prev-btn">
                <i class="fas fa-hourglass-half icon text-outline" style="font-size: 45px;"></i>
            </div>
            <div class="btn-box" id="play-btn"><i class="fas fa-play icon text-outline" style="font-size: 65px;"></i></div>
            <div class="btn-box" id="next-btn"><i class="fas fa-step-forward icon text-outline"></i></div>
        </div>

        <div class="footer">
            <div class="footer-row">
                <div class="footer-left-group">
                    <div class="btn-row">
                        <div class="new-btn" id="extra-btn-1" title="倒計時"><i class="fas fa-clock text-outline"></i></div>
                        <div class="new-btn" id="extra-btn-2" title="敬老模式"><i class="fas fa-person-walking-with-cane text-outline"></i></div>
                        <div class="new-btn" id="extra-btn-3" title="隱藏資訊"><i class="fas fa-eye-slash text-outline"></i></div>
                    </div>
                    <div class="btn-row">
                        <i class="fas fa-rotate-right restart-btn text-outline" onclick="location.reload()" title="重新開始"></i>
                        <div class="mode-btn" id="btn-seq" title="依序播放"><i class="fas fa-list-ol text-outline"></i></div>
                        <div class="mode-btn" id="btn-rand" title="隨機播放"><i class="fas fa-shuffle text-outline"></i></div>
                    </div>
                </div>

                <div class="area-selector">
                    <input type="checkbox" id="area-a" class="area-checkbox" value="A" checked>
                    <label for="area-a" class="area-label"><span class="letter">A區</span><span class="years">Before 1990</span></label>
                    <input type="checkbox" id="area-b" class="area-checkbox" value="B" checked>
                    <label for="area-b" class="area-label"><span class="letter">B區</span><span class="years">1991-2000</span></label>
                    <input type="checkbox" id="area-c" class="area-checkbox" value="C" checked>
                    <label for="area-c" class="area-label"><span class="letter">C區</span><span class="years">2001-2010</span></label>
                    <input type="checkbox" id="area-d" class="area-checkbox" value="D" checked>
                    <label for="area-d" class="area-label"><span class="letter">D區</span><span class="years">2011-2020</span></label>
                    <input type="checkbox" id="area-e" class="area-checkbox" value="E" checked>
                    <label for="area-e" class="area-label"><span class="letter">E區</span><span class="years">After 2021</span></label>
                    <!-- <input type="checkbox" id="area-f" class="area-checkbox" value="F" checked>
                    <label for="area-f" class="area-label"><span class="letter">F區</span><span class="years"></span></label> -->
                </div>
            </div>
        </div>
    </div>

    <div id="countdown-container"><div id="countdown-bar"></div></div>
    <div id="hourglass-container" class="progress-container"><div id="hourglass-bar"></div></div>
    <div id="yt-player-container"><div id="player"></div></div>

    <script>
        // --- 音訊合成引擎最終優化版 ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playCustomSound(freq, duration, volume, type = 'triangle') {
            try {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                
                gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(volume, audioCtx.currentTime + 0.02); // 更快的攻擊音
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) { console.log("音訊播放失敗:", e); }
        }

        // 儲存沙漏定時器，方便隨時停止
        let hourglassAudioTimers = [];

        const songData = {
            "A": [
                { year: 1979, singer: "蔡琴", title: "恰似你的溫柔", ytId: "bs4Wz_b5p90", start: 70 },
                { year: 1979, singer: "潘安邦", title: "外婆的澎湖灣", ytId: "oqeC2vbrfsQ", start: 65 },
                { year: 1977, singer: "鄧麗君", title: "月亮代表我的心", ytId: "wOuFMIVBPlM", start: 61 },
                { year: 1977, singer: "鳳飛飛", title: "我是一片雲", ytId: "dOV7qboUU9c", start: 45 },
                { year: 1978, singer: "鳳飛飛", title: "流水年華", ytId: "nKslRCuwhMk", start: 36 },
                { year: 1979, singer: "齊豫", title: "橄欖樹", ytId: "hEtX0rn8FjU", start: 47 },
                { year: 1973, singer: "歐陽菲菲", title: "熱情的沙漠", ytId: "cno9BFpdeGA", start: 40 },
                { year: 1971, singer: "楊小萍", title: "梨山痴情花", ytId: "ojiY0UgmRI8", start: 36 },
                { year: 1958, singer: "陳芬蘭", title: "孤女的願望(台)", ytId: "sL3mQgFk-hw", start: 44 },
                { year: 1960, singer: "文夏", title: "黃昏的故鄉(台)", ytId: "UehTlvCl_M0", start: 49 },
                { year: 1958, singer: "洪一峰", title: "思慕的人(台)", ytId: "KSMGPfKkIf8", start: 57 },
                { year: 1971, singer: "西卿", title: "苦海女神龍(台)", ytId: "bddzGfZt4hA", start: 42 },
                { year: 1980, singer: "尤雅", title: "等無人(台)", ytId: "FBj9qMMpWl0", start: 52 },
                { year: 1971, singer: "方瑞娥", title: "最後的火車站(台)", ytId: "1KotN2vrkmQ", start: 68 },
                { year: 1971, singer: "邱蘭芬", title: "走馬燈(台)", ytId: "GMYYuoI1dUo", start: 45 },
                { year: 1970, singer: "葉啟田", title: "內山姑娘要出嫁(台)", ytId: "14MUWf7AOlM", start: 58 },
                { year: 1959, singer: "郭金發", title: "燒肉粽(台)", ytId: "m45fUda0xP4", start: 47 },
                // { year: 1980, singer: "陳盈潔", title: "期待再相會(台)", ytId: "hEKV8QQ_8DA", start: 51 },
                { year: 1972, singer: "西卿", title: "粉紅色的腰帶(台)", ytId: "iR3T4O8Yeso", start: 37 },
                { year: 1977, singer: "鳳飛飛", title: "心酸酸(台)", ytId: "0V-9JUF4tF0", start: 51 },
                { year: 1969, singer: "姚蘇蓉", title: "今天不回家", ytId: "WbU-oWW0qXI", start: 76 },
                { year: 1970, singer: "尤雅", title: "往事只能回味", ytId: "zmgyHTt2Gsg", start: 53 },
                { year: 1972, singer: "崔苔菁", title: "但是又何奈", ytId: "VmvEy-ACZO4", start: 40 },
                { year: 1973, singer: "鄧麗君", title: "千言萬語", ytId: "iuXzZB_PBQA", start: 54 },
                { year: 1976, singer: "鳳飛飛", title: "巧合", ytId: "bCOW9ZtRii0", start: 28 },
                { year: 1978, singer: "張艾嘉", title: "童年", ytId: "V7Ltv-b_OcA", start: 92 },
                { year: 1978, singer: "高凌風", title: "大眼睛", ytId: "CKp0ObvXoUo", start: 51 },
                { year: 1980, singer: "王夢麟", title: "阿美阿美", ytId: "NoY2m1iSTsw", start: 44 },
                { year: 1974, singer: "鄧麗君", title: "一簾幽夢", ytId: "t0t0NWwRSOo", start: 75 },
                { year: 1973, singer: "鄧麗君", title: "玫瑰玫瑰我愛你", ytId: "YG63Zuurlxk", start: 35 },
                // { year: 1968, singer: "紀露霞", title: "望你早歸(台)", ytId: "DMfdgF4KN4k", start: 64 },
                { year: 1968, singer: "陳芬蘭", title: "快樂的出帆", ytId: "Pg_cb_Mn69A", start: 49 },
                { year: 1969, singer: "文夏", title: "媽媽請你也保重(台)", ytId: "O23DdAcgxo4", start: 38 },
                { year: 1970, singer: "葉啟田", title: "心所愛的人(台)", ytId: "TAWqTKL64qM", start: 63 },
                { year: 1960, singer: "洪一峰", title: "山頂的黑狗兄(台)", ytId: "6GXFA8mxXD8", start: 45 },
                { year: 1972, singer: "葉啟田", title: "墓仔埔也敢去(台)", ytId: "9HHGgXwuVzI", start: 60 },
                // { year: 1975, singer: "吳晉淮", title: "暗淡的月(台)", ytId: "JSaQLQtKG7Q", start: 59 },
                { year: 1976, singer: "葉啟田", title: "人生(台)", ytId: "D41zN65joz4", start: 67 },
                { year: 1980, singer: "陳盈潔", title: "期待再相會(台)", ytId: "hEKV8QQ_8DA", start: 112 },
                { year: 1979, singer: "陳盈潔", title: "天涯找愛人(台)", ytId: "bsDFYniy-K0", start: 34 },
                { year: 1981, singer: "劉文正", title: "三月裡的小雨", ytId: "7-7x9ddaBX8", start: 38 },
                { year: 1983, singer: "費玉清", title: "一剪梅", ytId: "AjitR7RZEQU", start: 93 },
                { year: 1983, singer: "蘇芮", title: "一樣的月光", ytId: "dqcoG9LUzgE", start: 79 },
                { year: 1987, singer: "王傑", title: "一場遊戲一場夢", ytId: "MjtUQmhKGuI", start: 62 },
                { year: 1987, singer: "齊秦", title: "大約在冬季", ytId: "qztCjZLHYEg", start: 55 },
                { year: 1988, singer: "巫啟賢", title: "妳是我的唯一", ytId: "zgH0YaZW5og", start: 62 },
                { year: 1989, singer: "陳淑樺", title: "夢醒時分", ytId: "BWbAdL92jqU", start: 63 },
                { year: 1990, singer: "林憶蓮", title: "愛上一個不回家的人", ytId: "TM5HEICCAE8", start: 86 },
                { year: 1982, singer: "沈文程", title: "心事誰人知(台)", ytId: "sUipHah7SoU", start: 29 },
                { year: 1982, singer: "洪榮宏", title: "一支小雨傘(台)", ytId: "4N8jQXUilas", start: 54 },
                { year: 1984, singer: "江蕙", title: "惜別的海岸(台)", ytId: "FHPrSjpBSu0", start: 72 },
                { year: 1985, singer: "陳小雲", title: "舞女(台)", ytId: "mL8RXLb93-8", start: 33 },
                { year: 1985, singer: "葉啟田", title: "乾一杯(台)", ytId: "xc17XcRG5eA", start: 36 },
                { year: 1987, singer: "阿吉仔", title: "命運的吉他(台)", ytId: "sZb0eQeVt4c", start: 59 },
                { year: 1987, singer: "黃乙玲", title: "講什麼山盟海誓(台)", ytId: "XM96xW1cum0", start: 78 },
                { year: 1987, singer: "龍千玉", title: "不如甭熟識(台)", ytId: "ftEfcHy3Iu0", start: 73 },
                { year: 1988, singer: "葉啟田", title: "愛拼才會贏(台)", ytId: "rBiE1dNaSqg", start: 50 },
                { year: 1988, singer: "蔡秋鳳", title: "金包銀(台)", ytId: "6R2yfAOYRlw", start: 57 },
                { year: 1988, singer: "賀一航", title: "媽媽請你不通痛(台)", ytId: "ZU_Rg3NOIqY", start: 82 },
                { year: 1990, singer: "王瑞霞", title: "絕情雨(台)", ytId: "Y_sypl1xnDw", start: 60 },
                { year: 1981, singer: "鳳飛飛", title: "愛你在心口難開", ytId: "FhuzROZbip0", start: 76 },
                { year: 1981, singer: "蔡琴", title: "被遺忘的時光", ytId: "qXN4xjlpWxw", start: 9 },
                { year: 1982, singer: "羅大佑", title: "鹿港小鎮", ytId: "l0STVc3YoR0", start: 68 },
                { year: 1982, singer: "丘丘合唱團(娃娃)", title: "就在今夜", ytId: "WzUSR8hreuk", start: 46 },
                { year: 1982, singer: "潘越雲", title: "野百合也有春天", ytId: "n3steo3LbkQ", start: 37 },
                { year: 1983, singer: "甄妮", title: "魯冰花", ytId: "Q9lkXH9Gjy0", start: 169 },
                { year: 1988, singer: "張雨生", title: "我的未來不是夢", ytId: "LjuFpidhiLo", start: 106 },
                { year: 1988, singer: "趙傳", title: "我很醜，可是我很溫柔", ytId: "G02sO-0bg8M", start: 79 },
                { year: 1989, singer: "小虎隊", title: "青蘋果樂園", ytId: "nkpSgYherKs", start: 73 },
                { year: 1989, singer: "小虎隊", title: "紅蜻蜓", ytId: "NbSf07Zr3ow", start: 84 },
                { year: 1989, singer: "童安格", title: "其實你不懂我的心", ytId: "Wr9SYsEYRao", start: 67 },
                { year: 1990, singer: "伍思凱", title: "特別的愛給特別的你", ytId: "hm0xK0dp134", start: 54 },
                { year: 1990, singer: "草蜢", title: "失戀陣線聯盟", ytId: "suIbr4JS5MA", start: 46 },
                { year: 1981, singer: "洪榮宏", title: "我是男子漢(台)", ytId: "FEjMv1W8dGk", start: 56 },
                { year: 1982, singer: "沈文程", title: "七桃人(台)", ytId: "5VUEHib4fMA", start: 38.5 },
                { year: 1988, singer: "陳小雲", title: "愛情的騙子我問你(台)", ytId: "LleqBkUeuEs", start: 8 },
                { year: 1988, singer: "葉啟田", title: "浪子的心情(台)", ytId: "yG7E6smLIEM", start: 55 },
                { year: 1988, singer: "羅時豐 & 王瑞霞", title: "小姐請你給我愛(台)", ytId: "xOrMMnfgcHE", start: 60 },
                { year: 1990, singer: "王識賢", title: "雙人枕頭(台)", ytId: "mAY61EhWeEE", start: 88 },
                { year: 1990, singer: "江蕙", title: "空笑夢(台)", ytId: "Xj-pbUkFBTE", start: 62 },
            ],
            "B": [
                { year: 1991, singer: "張清芳", title: "加州陽光", ytId: "MUQokGdc_eo", start: 50 },
                { year: 1993, singer: "黃安", title: "新鴛鴦蝴蝶夢", ytId: "7W4ghfVUIrw", start: 82.5 },
                { year: 1992, singer: "林志穎", title: "不是每個戀曲都有美好回憶", ytId: "WWMzuKj2bWM", start: 70 },
                { year: 1994, singer: "伍佰", title: "浪人情歌", ytId: "Ex9mW1mvgcw", start: 79 },
                { year: 1995, singer: "周華健", title: "朋友", ytId: "JFz0qv29Fzg", start: 73 },
                { year: 1996, singer: "蘇慧倫", title: "鴨子", ytId: "mZmfzIjh0aM", start: 54 },
                { year: 1997, singer: "張惠妹", title: "聽海", ytId: "4ChZ82y8Tzo", start: 129 },
                { year: 1998, singer: "任賢齊", title: "傷心太平洋", ytId: "SeSbEc-HatQ", start: 93 },
                { year: 1999, singer: "陶喆", title: "找自己", ytId: "0jJbW4sdDHk", start: 83 },
                { year: 1999, singer: "蕭亞軒", title: "最熟悉的陌生人", ytId: "Td5e0kzVlZQ", start: 80 },
                { year: 2000, singer: "周杰倫", title: "星晴", ytId: "F3gGxA4SbhY", start: 75 },
                { year: 2000, singer: "孫燕姿", title: "天黑黑", ytId: "mrTSszvVF74", start: 78 },
                { year: 1991, singer: "林強", title: "向前走(台)", ytId: "4n4DPG2wn2c", start: 95 },
                { year: 1992, singer: "張秀卿", title: "車站(台)", ytId: "Kl5UE15Koio", start: 59 },
                { year: 1992, singer: "黃乙玲", title: "愛到才知痛(台)", ytId: "UDZis_ajqio", start: 69 },
                { year: 1994, singer: "陳雷", title: "風真透(台)", ytId: "yolQ38EKlFc", start: 32 },
                { year: 1994, singer: "施文彬 & 江蕙", title: "傷心酒店(台)", ytId: "VwNZ4en7SmE", start: 55 },
                { year: 1999, singer: "五月天", title: "志明與春嬌(台)", ytId: "MHL00KwcGlU", start: 62 },
                { year: 1999, singer: "五月天", title: "I Love You 無望(台)", ytId: "ArnP8KKsL7M", start: 81 },
                { year: 2000, singer: "江蕙", title: "家後(台)", ytId: "6La0usd_dxU", start: 63 },
                { year: 1991, singer: "趙詠華", title: "最浪漫的事", ytId: "XCoWc-RowGk", start: 64 },
                { year: 1993, singer: "萬芳", title: "新不了情", ytId: "_bVcDcY59mg", start: 72 },
                { year: 1994, singer: "辛曉琪", title: "領悟", ytId: "1HeA4bDEAeg", start: 109 },
                { year: 1994, singer: "陳昇", title: "把悲傷留給自己", ytId: "7RLQlnPcVus", start: 67 },
                { year: 1995, singer: "林曉培", title: "煩", ytId: "T7G13yDNGTk", start: 62 },
                { year: 1996, singer: "許茹芸", title: "如果雲知道", ytId: "FRbaawcE3MI", start: 129 },
                { year: 1996, singer: "范曉萱", title: "健康歌", ytId: "IiTjONtWOLM", start: 40 },
                { year: 1997, singer: "陳曉東", title: "心有獨鍾", ytId: "FvY47uZI8lY", start: 86 },
                { year: 1999, singer: "張學友", title: "她來聽我的唱會", ytId: "SK2nOF6J9QY", start: 53 },
                { year: 1999, singer: "謝霆鋒", title: "謝謝你的愛1999", ytId: "syso6qEzskA", start: 66 },
                { year: 1999, singer: "梁詠琪", title: "膽小鬼", ytId: "8uwmtv9U5GM", start: 85 },
                { year: 1999, singer: "莫文蔚", title: "陰天", ytId: "8dWPCRRiehM", start: 47 },
                { year: 1994, singer: "伍佰", title: "素蘭小姐要出嫁(台)", ytId: "JcnflzMSegU", start: 76 },
                { year: 1995, singer: "施文彬", title: "再會啦心愛的無緣的人(台)", ytId: "EqoQhUaLYsI", start: 62 },
                { year: 1991, singer: "黃克林", title: "倒退嚕(台)", ytId: "-X2QLIcp160", start: 127 },
                { year: 1991, singer: "王識賢 & 陳亮吟", title: "雪中紅(台)", ytId: "ELhE733j3N8", start: 73 },
                { year: 1992, singer: "陳小雲", title: "愛情恰恰(台)", ytId: "eni2pPQl8Ic", start: 50 },
                { year: 1992, singer: "江蕙", title: "酒後的心聲(台)", ytId: "Pa77Fm5qyiA", start: 73 },
                { year: 1993, singer: "謝金燕", title: "含淚跳恰恰(台)", ytId: "_9JJx5EsOI4", start: 91 },
                { year: 1993, singer: "陳雷", title: "往事就是我的安慰(台)", ytId: "CuNhYt3wvfE", start: 82 },
                { year: 1994, singer: "吳宗憲", title: "真心換絕情(台)", ytId: "zQCPNxUAgFc", start: 101 }
            ],
            "C": [
                { year: 2004, singer: "周杰倫", title: "爸 我回來了", ytId: "kbLjLQPaQmU", start: 74 },
                { year: 2001, singer: "周杰倫", title: "忍者", ytId: "CtQhWZ8m-ws", start: 44 },
                { year: 2001, singer: "F4", title: "流星雨", ytId: "VPZJ6swbWS4", start: 67 },
                { year: 2003, singer: "蔡依林", title: "說愛你", ytId: "TbE-uKi8aMU", start: 172 },
                { year: 2005, singer: "光良", title: "童話", ytId: "0FJ1BCbTlXg", start: 40 },
                { year: 2006, singer: "蘇打綠", title: "小情歌", ytId: "AzpFdfhKAfY", start: 37 },
                { year: 2006, singer: "曹格 & 卓文萱", title: "梁山伯與茱麗葉", ytId: "lQTPpww75cY", start: 70 },
                { year: 2007, singer: "張惠妹", title: "如果你也聽說", ytId: "UP1aAvgYxLA", start: 68 },
                { year: 2007, singer: "飛兒樂團", title: "月牙灣", ytId: "udjKDXxBRNo", start: 72 },
                { year: 2008, singer: "蕭敬騰", title: "王妃", ytId: "UYNqKDsxwRo", start: 62 },
                { year: 2009, singer: "徐佳瑩", title: "身騎白馬", ytId: "TOsdcqo7kmk", start: 97 },
                { year: 2001, singer: "S.H.E", title: "戀人未滿", ytId: "CBAgq3QJx1Y", start: 66 },
                { year: 2001, singer: "郭桂彬 & 黃乙玲", title: "海波浪(台)", ytId: "qnApWFY3_gw", start: 96 },
                { year: 2001, singer: "阿吉仔", title: "作陣彼一暝(台)", ytId: "3SdUxQZksNE", start: 86 },
                { year: 2001, singer: "王識賢", title: "愛到無命不知驚(台)", ytId: "8TDy710vhTE", start: 53 },
                { year: 2001, singer: "康康", title: "恁姐仔住市內(台)", ytId: "AB1GxejnmbE", start: 46 },
                { year: 2002, singer: "袁小迪 & 龍千玉", title: "男人情女人心(台)", ytId: "2a1pZkEAWmg", start: 83 },
                { year: 2002, singer: "江蕙 & 阿杜", title: "夢中的情話(台)", ytId: "xt4xXTz2rw0", start: 125 },
                { year: 2004, singer: "王識賢 & 孫淑媚", title: "雲中月圓(台)", ytId: "iyVRksmmTx8", start: 100 },
                { year: 2004, singer: "王識賢", title: "情難忘(台)", ytId: "GnQs4JlQ0ak", start: 66 },
                { year: 2001, singer: "李玟", title: "刀馬旦", ytId: "NdwQ6pUKKnM", start: 77 },
                { year: 2001, singer: "陳奕迅", title: "K歌之王", ytId: "lN4J3zB_VuE", start: 76 },
                { year: 2002, singer: "Energy", title: "放手", ytId: "tqlOfFhc0Ig", start: 91 },
                { year: 2003, singer: "潘瑋柏", title: "壁虎漫步", ytId: "iVXX9NGnz6M", start: 55.3 },
                { year: 2004, singer: "林依晨", title: "孤單北半球", ytId: "ewcGjRkAEhU", start: 63 },
                { year: 2005, singer: "柯有倫", title: "零", ytId: "DHumhswVAk0", start: 80 },
                { year: 2006, singer: "Tank", title: "專屬天使", ytId: "5jyguyCw-yo", start: 170.5 },
                { year: 2008, singer: "楊宗緯", title: "洋蔥", ytId: "DKDlPiQRHvY", start: 75 },
                { year: 2008, singer: "梁靜茹", title: "會呼吸的痛", ytId: "vZ1fCcPUuPM", start: 228.5 },
                { year: 2008, singer: "盧廣仲", title: "早安，晨之美！", ytId: "LOTIKY4h-M8", start: 28 },
                { year: 2009, singer: "丁當", title: "我愛他", ytId: "RaxDsOR64CU", start: 103 },
                { year: 2009, singer: "林宥嘉", title: "說謊", ytId: "8nI9mjp6vuk", start: 73 },
                { year: 2002, singer: "陳雷", title: "歡喜就好(台)", ytId: "69XwkAF8kbg", start: 56 },
                { year: 2003, singer: "翁立友", title: "我問天(台)", ytId: "oW4-don-sTU", start: 70.5 },
                { year: 2005, singer: "黃乙玲", title: "人生的歌(台)", ytId: "iyIMSi8NUlA", start: 74 },
                { year: 2005, singer: "翁立友", title: "堅持(台)", ytId: "CfX7uGZ1_zI", start: 66.5 },
                { year: 2005, singer: "袁小迪", title: "重出江湖(台)", ytId: "2bbVrG95dmY", start: 67.5 },
                { year: 2006, singer: "蕭煌奇", title: "阿嬤的話(台)", ytId: "A83IJhXR7sY", start: 105 },
                { year: 2008, singer: "江蕙", title: "甲你攬牢牢(台)", ytId: "yJ3mr8yN4_Y", start: 90.5 },
                { year: 2009, singer: "蕭煌奇", title: "心裡有針(台)", ytId: "jgWMxyeJE8I", start: 73.5 }
            ],
            "D": [
                { year: 2011, singer: "陳勢安", title: "天后", ytId: "dvW1rPD0-nQ", start: 73 },
                { year: 2011, singer: "謝和弦", title: "牽心萬苦", ytId: "CRBJCjSlAgM", start: 55 },
                { year: 2011, singer: "胡夏", title: "那些年", ytId: "MMxcWJsfbQw", start: 99.5 },
                { year: 2011, singer: "韋禮安", title: "還是會", ytId: "6Levfx3DLB4", start: 61 },
                { year: 2012, singer: "陳芳語", title: "愛你", ytId: "RGnlTJTuVzs", start: 140 },
                { year: 2012, singer: "鄧紫棋", title: "泡沫", ytId: "CQEXldyfGGM", start: 120.5 },
                { year: 2012, singer: "曲婉婷", title: "我的歌聲裡", ytId: "FpDbAtk_1Dw", start: 42 },
                { year: 2015, singer: "田馥甄", title: "小幸運", ytId: "XIYTWH_iUqU", start: 83 },
                { year: 2015, singer: "A-Lin", title: "給我一個理由忘記", ytId: "cSwRe9CYj2Y", start: 101 },
                { year: 2016, singer: "任賢齊", title: "對摺", ytId: "iIgaDY712Xs", start: 69 },
                { year: 2016, singer: "周湯豪", title: "帥到分手", ytId: "cHuuqcvI9II", start: 59 },
                { year: 2017, singer: "黃明志 & 王力宏", title: "漂向北方", ytId: "_u5RGZspR64", start: 76 },
                { year: 2018, singer: "八三夭", title: "想見你想見你想見你", ytId: "yKDpjiUbRmE", start: 65 },
                { year: 2018, singer: "李榮浩", title: "年少有為", ytId: "kyWTlhXL2G4", start: 87 },
                { year: 2019, singer: "告五人", title: "披星戴月的想你", ytId: "lSg2ajAqAug", start: 89 },
                { year: 2020, singer: "盧廣仲", title: "刻在我心底的名字", ytId: "2sX45Oyd1n0", start: 132 },
                { year: 2014, singer: "李千娜", title: "心花開(台)", ytId: "48Spa7unh0A", start: 66 },
                { year: 2017, singer: "滅火器樂團", title: "長途夜車(台)", ytId: "tp9NDsOBfUM", start: 91 },
                { year: 2017, singer: "茄子蛋", title: "浪子回頭(台)", ytId: "5SpuDtWbDX8", start: 110 },
                { year: 2020, singer: "徐若瑄", title: "別人的(台)", ytId: "d7uhe_zDa_k", start: 89 },
                { year: 2011, singer: "謝和弦", title: "於是長大了以後", ytId: "d19n-oJ6hQU", start: 63.5 },
                { year: 2011, singer: "林凡", title: "五天幾年", ytId: "uiojIfCSpqs", start: 50 },
                { year: 2011, singer: "蕭煌奇", title: "末班車", ytId: "eNt5JqW5k60", start: 86 },
                { year: 2012, singer: "S.H.E", title: "花又開好了", ytId: "-wU_mycyVe0", start: 57.5 },
                { year: 2012, singer: "八三夭", title: "東區東區", ytId: "dH2o_ImhFnA", start: 56 },
                { year: 2013, singer: "田馥甄", title: "不醉不會", ytId: "ESlYFW7l_Iw", start: 70 },
                { year: 2014, singer: "陳零九", title: "我只是害怕不在你身旁", ytId: "cQn6vdCEdAM", start: 66.5 },
                { year: 2015, singer: "張惠妹", title: "血腥愛情故事", ytId: "-YtsnlPvPt8", start: 108 },
                { year: 2017, singer: "盧廣仲", title: "魚仔", ytId: "ka-0nrGphZY", start: 67.5 },
                { year: 2017, singer: "張惠妹", title: "連名帶姓", ytId: "INOXA0DtsR4", start: 97.5 },
                { year: 2017, singer: "J.Sheon", title: "別問很可怕", ytId: "MRlGgrH9nyY", start: 68 },
                { year: 2017, singer: "美秀集團", title: "捲菸", ytId: "Bk5l-hvguUc", start: 52.5 },
                { year: 2019, singer: "高爾宣", title: "沒了你 Without You", ytId: "H_R4klZD3Ew", start: 60.5 },
                { year: 2019, singer: "告五人", title: "愛人錯過", ytId: "XlaZ3-Jnmzs", start: 81 },
                { year: 2019, singer: "陳零九 & 邱鋒澤", title: "天黑請閉眼", ytId: "QL11vms3v7I", start: 67.5 },
                { year: 2020, singer: "周杰倫", title: "Mojito", ytId: "zgqBH0_XfZ0", start: 60.5 },
                { year: 2012, singer: "荒山亮", title: "趁我還會記(台)", ytId: "2F_Oi5I_V5k", start: 78 },
                { year: 2017, singer: "盧廣仲", title: "明仔載(台)", ytId: "6koKnqOW_RM", start: 11 },
                { year: 2019, singer: "茄子蛋", title: "Happy!!! 運將情歌(台)", ytId: "zKxTnkgcBlY", start: 185 }
            ],
            "E": [
                { year: 2021, singer: "動力火車", title: "我很好騙", ytId: "efmtFFnZOGA", start: 63 },
                // { year: 2024, singer: "邱軍", title: "運轉人生(台)", ytId: "n18Vw5VT5UE", start: 47 },
            ]
        };

        // --- 全域變數 ---
        let currentIndex = 0, player, isPlayerReady = false, stopTimer;
        let currentMode = 'rand'; 
        let selectedBgColor = "rgb(255, 255, 0)"; 
        let selectedAreaKeys = [], currentAreaCycle = [], cyclePointer = 0, nonOldestCounter = 0;
        let sessionPlayedSongs = [];
        let records = JSON.parse(localStorage.getItem('guess_song_records')) || [];
        let activeRecordIndex = -1, currentChallengeSong = null;

        function saveRecordsToLocal() { localStorage.setItem('guess_song_records', JSON.stringify(records)); }

        // --- 計數器邏輯 ---
        function updateSongCounter() {
            // 1. 計算選中區域的總曲目數
            let total = 0;
            selectedAreaKeys.forEach(k => { total += songData[k].length; });

            // 2. 計算選中區域中「已聽過」的數量
            let blackList = (activeRecordIndex !== -1) ? records[activeRecordIndex].playedSongs : sessionPlayedSongs;
            let current = 0;
            
            // 遍歷黑名單，檢查該歌是否屬於目前的勾選區域
            blackList.forEach(ytId => {
                for (let key of selectedAreaKeys) {
                    if (songData[key].some(s => s.ytId === ytId)) {
                        current++;
                        break; 
                    }
                }
            });

            $("#song-counter").text(`${current} / ${total}`);
        }

        // --- 核心過濾與隨機邏輯 ---
        function getUnplayedFromArea(areaKey) {
            const pool = songData[areaKey] || [];
            let blackList = (activeRecordIndex !== -1) ? records[activeRecordIndex].playedSongs : sessionPlayedSongs;
            return pool.filter(s => !blackList.includes(s.ytId));
        }

        function getNextRandomSong() {
            if (selectedAreaKeys.length === 0) return null;

            // 1. 找出當前勾選區域中的「最前一區」 (年代最久遠的那一區)
            const firstArea = selectedAreaKeys[0]; 
            const isSeniorMode = $("#extra-btn-2").hasClass("active");
            let targetArea = "";
            let isSeniorTrigger = false;

            // 2. 判斷是否需要強制插播：連續兩首非第一區，第三首必出
            if (isSeniorMode && nonOldestCounter >= 2) {
                // 強制設目標為第一區
                const pool = getUnplayedFromArea(firstArea);
                if (pool.length > 0) {
                    targetArea = firstArea;
                    isSeniorTrigger = true;
                    console.log("敬老模式強制：連續兩首非最前區，第三首插播 " + targetArea + "區");
                } else {
                    // 如果最前區沒歌了，就走正常輪替
                    targetArea = currentAreaCycle[cyclePointer];
                }
            } else {
                // 正常輪替邏輯
                targetArea = currentAreaCycle[cyclePointer];
                
                // 檢查該區是否還有新歌，沒歌就跳下一區
                let pool = getUnplayedFromArea(targetArea);
                if (pool.length === 0) {
                    let attempts = 0;
                    while (pool.length === 0 && attempts < selectedAreaKeys.length) {
                        cyclePointer = (cyclePointer + 1) % currentAreaCycle.length;
                        targetArea = currentAreaCycle[cyclePointer];
                        pool = getUnplayedFromArea(targetArea);
                        attempts++;
                    }
                }
            }

            const finalPool = getUnplayedFromArea(targetArea);
            if (finalPool.length === 0) return null; 

            const pickedSong = finalPool[Math.floor(Math.random() * finalPool.length)];

            // 3. 更新計數器：如果是出「最前一區」的歌就歸零，否則加1
            if (targetArea === firstArea) {
                nonOldestCounter = 0;
            } else {
                nonOldestCounter++;
            }

            // 4. 更新輪替指針
            cyclePointer = (cyclePointer + 1) % currentAreaCycle.length;
            if (cyclePointer === 0) {
                currentAreaCycle = [...selectedAreaKeys].sort(() => Math.random() - 0.5);
            }

            // 日誌打印
            if (isSeniorTrigger) console.log("觸發敬老模式");
            console.log(targetArea + "區");

            return pickedSong;
        }

        function renderSong() {
            resetCountdown();
            resetHourglass();
            if (currentMode === 'rand') {
                currentChallengeSong = getNextRandomSong();
            } else {
                let fullList = []; selectedAreaKeys.forEach(k => fullList = fullList.concat(songData[k]));
                fullList = fullList.filter(s => {
                    if (activeRecordIndex !== -1) {
                        return !records[activeRecordIndex].playedSongs.includes(s.ytId);
                    } else {
                        return !sessionPlayedSongs.includes(s.ytId);
                    }
                });
                currentChallengeSong = fullList[0] || null;
                if (currentChallengeSong) {
                    for (let area in songData) {
                        if (songData[area].find(s => s.ytId === currentChallengeSong.ytId)) { console.log(area + "區"); break; }
                    }
                }
            }

            if (!currentChallengeSong) { 
                $("#display-info").text("此條件下已無新歌！"); 
                $("#display-title").text("請讀取其他記錄或重新整理"); 
                updateSongCounter();
                return; 
            }

            if (activeRecordIndex !== -1) {
                if (!records[activeRecordIndex].playedSongs.includes(currentChallengeSong.ytId)) { records[activeRecordIndex].playedSongs.push(currentChallengeSong.ytId); saveRecordsToLocal(); }
            } else {
                if (!sessionPlayedSongs.includes(currentChallengeSong.ytId)) sessionPlayedSongs.push(currentChallengeSong.ytId);
            }

            updateSongCounter();

            const isMasked = $("#extra-btn-3").hasClass("active");
            $("#song-display").css("opacity", 0);
            setTimeout(() => {
                let s = currentChallengeSong.singer, t = currentChallengeSong.title;
                if (isMasked) {
                    s = "*".repeat(s.length);
                    const bIdx = t.lastIndexOf("(");
                    if (bIdx !== -1) {
                        t = "*".repeat(t.substring(0, bIdx).length) + t.substring(bIdx);
                    } else {
                        t = "*".repeat(t.length);
                    }
                }
                $("#display-info").text(currentChallengeSong.year + " - " + s);
                $("#display-title").text(t);
                $("#song-display").css("opacity", 1);
            }, 200);

            if (isPlayerReady) player.stopVideo();
            clearTimeout(stopTimer);
        }

        function initColorPicker() {
            const colors = ["rgb(255, 255, 0)", "rgb(255, 165, 0)", "rgb(255, 140, 0)", "rgb(255, 215, 0)", "rgb(50, 205, 50)", "rgb(0, 128, 0)", "rgb(34, 139, 34)", "rgb(173, 255, 47)", "rgb(128, 128, 0)", "rgb(189, 183, 107)", "rgb(139, 69, 19)", "rgb(210, 105, 30)", "rgb(255, 192, 203)", "rgb(255, 105, 180)", "rgb(218, 112, 214)", "rgb(128, 128, 128)"];
            const $picker = $("#color-picker").empty();
            colors.forEach(c => {
                const $box = $("<div>").addClass("color-box").css("background-color", c);
                if(c === selectedBgColor) $box.addClass("selected");
                $box.click(function() { $(".color-box").removeClass("selected"); $(this).addClass("selected"); selectedBgColor = c; });
                $picker.append($box);
            });
        }

        function renderRecordList() {
            const $list = $("#record-display-list").empty();
            if (records.length === 0) { $list.append("<p style='color:#888;'>尚未有任何記錄</p>"); return; }
            records.forEach((rec, index) => {
                const $item = $(`<div class="record-item"><div class="record-info" data-index="${index}"><div class="record-color-preview" style="background:${rec.color}"></div><div class="record-name text-outline">${rec.name}</div></div><i class="fas fa-trash-can record-del-btn" data-index="${index}"></i></div>`);
                $list.append($item);
            });
            $(".record-info").click(function() { loadRecord($(this).data("index")); $("#modal-c").fadeOut(); });
            $(".record-del-btn").click(function(e) {
                e.stopPropagation(); const idx = $(this).data("index");
                if (confirm(`確定要刪除「${records[idx].name}」嗎？`)) {
                    records.splice(idx, 1);
                    if (activeRecordIndex === idx) activeRecordIndex = -1; else if (activeRecordIndex > idx) activeRecordIndex--;
                    saveRecordsToLocal(); renderRecordList(); updateSongCounter();
                }
            });
        }

        function loadRecord(index) {
            sessionPlayedSongs = []; 
            currentChallengeSong = null;
            activeRecordIndex = index;
            const rec = records[index];
            $("#status-msg").text(rec.name);
            const transparentColor = rec.color.replace("rgb", "rgba").replace(")", ", 0.5)");
            $("body").css("background-color", transparentColor);
            selectedBgColor = rec.color;
            switchMode(currentMode);
        }

        function switchMode(mode) {
            currentMode = mode; $(".mode-btn").removeClass("active"); resetCountdown();
            selectedAreaKeys = [];
            ["A", "B", "C", "D", "E"].forEach(v => { if ($("#area-" + v.toLowerCase()).is(":checked")) selectedAreaKeys.push(v); });
            if (selectedAreaKeys.length === 0) return;

            if (mode === 'rand') {
                $("#btn-rand").addClass("active");
                currentAreaCycle = [...selectedAreaKeys].sort(() => Math.random() - 0.5);
                cyclePointer = 0; nonOldestCounter = 0;
            } else {
                $("#btn-seq").addClass("active");
            }
            renderSong();
        }

        function resetCountdown() { $("#countdown-bar").stop().css({ width: '100%' }); $("#countdown-container").hide(); }

        // 開始自定義秒數的紫色沙漏跑條 (含音效)
        function startHourglassCountdown() {
            const $container = $("#hourglass-container"), $bar = $("#hourglass-bar");
            resetHourglass(); 

            // 取得用戶設定的秒數，若無則預設 10
            let customSeconds = parseInt($("#hourglass-time-input").val()) || 10;
            if (customSeconds < 10) customSeconds = 10; // 二次保險
            let totalMs = customSeconds * 1000;

            // 1. 啟動音：維持原定頻率與高音量
            playCustomSound(400, 0.5, 3.0, 'triangle'); 
            
            $container.show();
            $bar.css({ width: '100%' });
            
            // 動畫時間改為動態總毫秒
            $bar.animate({ width: '0%' }, totalMs, "linear", function() {
                // --- 3. 結束音 (0s)：連續三聲 ---
                playCustomSound(500, 0.4, 13.5, 'triangle'); 
                hourglassAudioTimers.push(setTimeout(() => {
                    playCustomSound(500, 0.4, 13.5, 'triangle');
                }, 300));
                hourglassAudioTimers.push(setTimeout(() => {
                    playCustomSound(500, 0.8, 15.0, 'triangle'); 
                }, 600));

                $container.fadeOut(500);
            });

            // 2. 固定在最後 5 秒時提醒：連續兩聲
            // 計算延遲時間 = (總秒數 - 5秒) * 1000
            let reminderDelay = (customSeconds - 5) * 1000;
            hourglassAudioTimers.push(setTimeout(() => {
                playCustomSound(500, 0.25, 2.5, 'triangle');
                hourglassAudioTimers.push(setTimeout(() => {
                    playCustomSound(500, 0.25, 2.5, 'triangle');
                }, 300));
            }, reminderDelay));
        }

        // 重置/收起紫色沙漏跑條
        function resetHourglass() {
            // 停止所有排程中的聲音 (主要是 5s 那聲)
            hourglassAudioTimers.forEach(clearTimeout);
            hourglassAudioTimers = [];
            
            $("#hourglass-bar").stop().css({ width: '100%' });
            $("#hourglass-container").hide();
        }

        function startCountdown() {
            if (!$("#extra-btn-1").hasClass("active")) return;
            const $container = $("#countdown-container"), $bar = $("#countdown-bar");
            
            // 讀取 MENU 裡的倒數設定
            let seconds = parseInt($("#countdown-time-input").val()) || 15;
            if (seconds < 1) seconds = 1; // 最少 1 秒
            let totalMs = seconds * 1000;

            $container.hide();
            $bar.stop().css({ width: '100%' });
            $container.show();
            $bar.animate({ width: '0%' }, totalMs, "linear", function() {
                $container.fadeOut();
            });
        }

        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('player', {
                height: '200', width: '200',
                playerVars: { 'autoplay': 0, 'controls': 0, 'rel': 0, 'playsinline': 1, 'origin': window.location.origin },
                events: {
                    'onReady': function() { isPlayerReady = true; },
                    'onStateChange': function(event) {
                        if (event.data == 1) { resetCountdown(); clearTimeout(stopTimer); stopTimer = setTimeout(() => { player.pauseVideo(); startCountdown(); }, 5000); }
                    }
                }
            });
        };

        $(document).ready(function() {
            initColorPicker(); switchMode('rand');

            // 倒數設定輸入檢查
            $("#countdown-time-input").on('change blur', function() {
                let val = parseInt($(this).val());
                if (isNaN(val) || val < 1) $(this).val(15);
            });
            
            $("#menu-icon").click(() => { $("#modal-a").fadeIn().css("display","flex"); });
            $("#go-to-b").click(() => { $("#modal-a").hide(); $("#modal-b").fadeIn().css("display","flex"); initColorPicker(); });
            $("#go-to-c").click(() => { $("#modal-a").hide(); renderRecordList(); $("#modal-c").fadeIn().css("display","flex"); });
            $("#cancel-b").click(() => $("#modal-b").fadeOut());

            $("#menu-toggle-senior").click(function() { $("#extra-btn-2").click(); syncMenuText(); });
            $("#menu-toggle-countdown").click(function() { $("#extra-btn-1").click(); syncMenuText(); });

            $("#confirm-b").click(() => {
                const name = $("#user-name-input").val().trim();
                if (!name) { alert("請輸入用戶名稱！"); return; }
                
                sessionPlayedSongs = []; 
                currentChallengeSong = null;
                const newRec = { name: name, color: selectedBgColor, playedSongs: [] };
                if (records.length >= 4) records.shift();
                records.push(newRec); activeRecordIndex = records.length - 1; saveRecordsToLocal();

                $("#status-msg").text(name);
                const transparentColor = selectedBgColor.replace("rgb", "rgba").replace(")", ", 0.5)");
                $("body").css("background-color", transparentColor);
                
                $("#modal-b").fadeOut();
                switchMode(currentMode);
            });

            $("#btn-seq").click(() => switchMode('seq'));
            $("#btn-rand").click(() => switchMode('rand'));
            $(".area-checkbox").change(function() { 
                if ($(".area-checkbox:checked").length < 2) $("#extra-btn-2").removeClass("active");
                switchMode(currentMode); 
            });

            $(".new-btn").click(function() {
                if (this.id === "extra-btn-2" && $(".area-checkbox:checked").length < 2) return;
                $(this).toggleClass("active");
                if (this.id === "extra-btn-3") renderSong();
                if (this.id === "extra-btn-1" && !$(this).hasClass("active")) resetCountdown();
            });

            $("#play-btn").click(function() {
                if (!isPlayerReady || !currentChallengeSong) return;
                resetCountdown();
                resetHourglass();
                player.playVideo(); player.unMute(); player.setVolume(100);
                player.loadVideoById({ videoId: currentChallengeSong.ytId, startSeconds: currentChallengeSong.start });
            });

            $("#next-btn").click(function() {
                renderSong();
            });

            // 點擊沙漏按鈕 (原 prev-btn) 觸發倒數
            $("#prev-btn").click(function() {
                resetCountdown();       // 先關閉綠色跑條（如果有的話）
                resetHourglass();       // 先重置紫色跑條（避免連續點擊重疊）
                startHourglassCountdown(); // 啟動 10 秒紫色跑條
            });
        });

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>
</body>
</html>